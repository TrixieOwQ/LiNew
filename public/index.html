<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Lilivine Fashion</title>
    <link rel="icon" href="f/logo.webp" type="image/webp">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        @font-face {
            font-family: 'Rounded Mplus 1c';
            src: url('8.ttf') format('woff');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        
        body, button, input, textarea, select {
            font-family: 'Rounded Mplus 1c', 'Arial', sans-serif;
            letter-spacing: .3px;
            color: #f0f0f0;
            overscroll-behavior: none;
        }
        
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: -1;
        }
        
        body {
            background: #0f3460;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        #world {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
        }
        
        .container {
            position: absolute;
            width: 90%;
            max-width: 500px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: none;
            border-radius: 16px;
            padding: 25px;
            background: rgba(25, 25, 45, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }
        
        .btn {
            background: rgba(69, 105, 144, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: rgba(89, 125, 164, 0.4);
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .form-cont {
            max-width: 400px;
        }
        
        .shop-cont {
            max-width: 800px;
            overflow-y: auto;
            max-height: 85vh;
        }
        
        .shop-title {
            color: white;
            font-size: 24px;
            text-align: center;
            margin: 15px 0 25px;
            font-weight: 600;
        }
        
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .shop-item {
            background: rgba(40, 40, 65, 0.6);
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.2s ease;
        }
        
        .shop-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .shop-img {
            width: 100%;
            height: 200px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
        }
        
        .shop-content {
            padding: 18px;
        }
        
        .item-title {
            color: #fff;
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .item-desc {
            color: rgba(220, 220, 220, 0.8);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 12px;
            min-height: 60px;
        }
        
        .item-price {
            color: #a0e0a0;
            font-size: 18px;
            font-weight: 600;
            margin: 12px 0;
        }
        
        .add-cart {
            background: rgba(80, 140, 100, 0.3);
            border: 1px solid rgba(100, 180, 100, 0.3);
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            text-align: center;
            margin-top: 10px;
        }
        
        .add-cart:hover {
            background: rgba(100, 160, 120, 0.5);
        }
        
        .logo-cont {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            border-radius: 50%;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo {
            width: 80%;
            height: 80%;
            object-fit: contain;
        }
       
        .form-title {
            color: white;
            font-size: 22px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: rgba(220, 220, 220, 0.9);
            margin-bottom: 8px;
            font-size: 15px;
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            background: rgba(50, 50, 75, 0.3);
            border: 1px solid rgba(100, 100, 150, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 15px;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            border-color: rgba(180, 180, 220, 0.6);
            outline: none;
            background: rgba(60, 60, 90, 0.4);
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            gap: 15px;
        }
        
        .form-btn {
            padding: 14px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 15px;
            flex: 1;
            font-weight: 500;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-btn.cancel {
            background: rgba(150, 60, 60, 0.3);
        }
        
        .form-btn.submit {
            background: rgba(80, 150, 80, 0.3);
        }
        
        .form-btn.submit:hover {
            background: rgba(100, 170, 100, 0.4);
        }
        
        .form-btn:hover {
            transform: translateY(-2px);
        }
        
        .form-btn:active {
            transform: translateY(1px);
        }
        
        .success-cont {
            max-width: 400px;
            text-align: center;
        }
        
        .success-icon {
            color: #70c070;
            font-size: 60px;
            margin-bottom: 20px;
            animation: pulseSuccess 3s infinite;
        }
        
        @keyframes pulseSuccess {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }
        
        .success-title {
            color: #e0f0e0;
            font-size: 24px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .success-msg {
            color: rgba(220, 240, 220, 0.9);
            margin-bottom: 25px;
            font-size: 16px;
            line-height: 1.6;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: flex;
            gap: 20px;
        }
        
        .star {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }
        
        .star:nth-child(2) { animation-delay: 0.4s; }
        .star:nth-child(3) { animation-delay: 0.8s; }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        .cart-cont {
            max-width: 600px;
            overflow-y: auto;
            max-height: 85vh;
        }
        
        .cart-title {
            color: white;
            font-size: 24px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(50, 50, 75, 0.3);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .cart-img {
            width: 70px;
            height: 70px;
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin-right: 15px;
        }
        
        .cart-info {
            flex: 1;
        }
        
        .cart-item-title {
            color: #fff;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .cart-price {
            color: #a0e0a0;
            font-size: 16px;
        }
        
        .rem-item {
            color: #e74c3c;
            cursor: pointer;
            margin-left: 15px;
            transition: all 0.2s ease;
        }
        
        .rem-item:hover {
            transform: scale(1.1);
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            margin: 25px 0;
            padding: 15px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .total-label {
            color: #ccc;
        }
        
        .total-amount {
            color: #a0e0a0;
            font-weight: 700;
        }
        
        .cart-actions {
            display: flex;
            gap: 15px;
        }
        
        .cart-btn {
            flex: 1;
            padding: 14px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .cont-shopping {
            background: rgba(100, 100, 150, 0.3);
        }
        
        .checkout {
            background: rgba(80, 150, 80, 0.3);
        }
        
        .cart-btn:hover {
            transform: translateY(-2px);
        }
        
        .cart-btn:active {
            transform: translateY(1px);
        }
        
        .cart-btn-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .cart-icon {
            width: 20px;
            height: 20px;
            fill: #e0e0e0;
        }
        
        .gal-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .gal-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            z-index: 10;
            display: flex;
            justify-content: flex-start;
        }
        
        .close-gal {
            background: 0;
            border: 0;
            color: #fff;
            font-size: 40px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            position: relative;
        }
        
        .gal-main {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .gal-slider {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.35s ease;
        }
        
        .gal-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            flex-shrink: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gal-img img {
            max-height: 85vh;
            max-width: 85vw;
            object-fit: contain;
        }
        
        .gal-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            color: #fff;
            font-size: 18px;
            z-index: 10;
        }
        
        .size-select {
            width: 100%;
            padding: 10px;
            background: rgba(50, 50, 75, 0.3);
            border: 1px solid rgba(100, 100, 150, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            margin: 10px 0;
        }
        
        .out-of-stock {
            background: rgba(150, 60, 60, 0.3) !important;
            border: 1px solid rgba(200, 80, 80, 0.3) !important;
            cursor: not-allowed;
        }
        
        .no-products {
            text-align: center;
            padding: 30px;
            color: rgba(220, 220, 220, 0.7);
            font-size: 18px;
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .shop-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            .gal-img img {
                max-height: 70vh;
            }
        }
        
        @media (max-width: 480px) {
            .btn { padding: 14px; font-size: 16px; }
            .container {
                width: 95%;
                padding: 18px;
            }
            .shop-grid { grid-template-columns: 1fr; }
            .logo-cont { width: 100px; height: 100px; }
            .cart-actions { flex-direction: column; }
            .cart-btn { width: 100%; }
            .close-gal { font-size: 35px; }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(40, 40, 60, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(100, 100, 150, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(140, 140, 180, 0.6);
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
    </div>
    
    <div id="world">
        <div class="container form-cont" id="formCont">
            <h2 class="form-title">Оформлення замовлення</h2>
            <div class="form-group">
                <label class="form-label">Повне Ім'я</label>
                <input type="text" class="form-input" id="name" required maxlength="30">
            </div>
            <div class="form-group">
                <label class="form-label">Контактна інформація</label>
                <input type="text" class="form-input" id="contact" required maxlength="50">
            </div>
            <div class="form-actions">
                <button class="form-btn cancel" id="cancelBtn">Повернутися</button>
                <button class="form-btn submit" id="submitBtn">Завершити</button>
            </div>
        </div>
        
        <div class="container shop-cont" id="shopCont">
            <div class="logo-cont">
                <img src="f/logo.webp" alt="Lilivine Fashion" class="logo">
            </div>
            
            <h2 class="shop-title"></h2>
            
            <div class="shop-grid" id="sGrid">
                <div class="no-products">Товарів немає. Будь ласка, зайдіть пізніше.</div>
            </div>
            <button class="btn" id="cartBtn">
                <div class="cart-btn-wrap">
                    <svg class="cart-icon" viewBox="0 0 24 24">
                        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                    </svg>
                    <span>Кошик</span>
                    <span id="cartCount">(0)</span>
                </div>
            </button>
        </div>
        
        <div class="container cart-cont" id="cartCont">
            <h2 class="cart-title">Ваш Кошик</h2>
            <div class="cart-items" id="cItems"></div>
            <div class="cart-total">
                <span class="total-label">Разом:</span>
                <span class="total-amount" id="totalAmt">₴0.00</span>
            </div>
            <div class="cart-actions">
                <button class="cart-btn cont-shopping" id="contShopBtn">Продовжити Покупки</button>
                <button class="cart-btn checkout" id="checkoutBtn">Оформити Замовлення</button>
            </div>
        </div>
        
        <div class="container success-cont" id="succCont">
            <div class="success-icon">✓</div>
            <h2 class="success-title">Замовлення Підтверджено!</h2>
            <p class="success-msg" id="succMsg"></p>
            <button class="btn" id="succBtn">Повернутися</button>
        </div>
    </div>
    
    <div class="gal-modal" id="galModal">
        <div class="gal-header">
            <button class="close-gal" id="closeGal">✕</button>
        </div>
        <div class="gal-main" id="galMain">
            <div class="gal-slider" id="galSlider"></div>
        </div>
        <div class="gal-footer">
            <div id="galCount">1/1</div>
        </div>
    </div>

    <script>
        const txt = {
            succMsg: (n,c) => `Дякуємо ${n}, ми зв'яжемося з вами за ${c} протягом 24 годин.`,
            remove: "Видалити",
            emptyCart: "Ваш кошик порожній",
            outOfStock: "Товар закінчився",
            noProducts: "Товарів немає. Будь ласка, зайдіть пізніше."
        };
        
        let galImgs = [], galIdx = 0, startX = 0, startTime = 0, swiping = false, sliderPos = 0;
        const swipeThres = 50, velThres = 0.3;
        let animating = false;
        let products = [];
        let cart = [];

        async function init() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('world').style.opacity = '1';
            loadProducts();
            
            setupEvents();
            setupGallery();
            updateCartCount();
        }
        
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                if (!response.ok) throw new Error('Помилка завантаження');
                
                products = await response.json();
                renderProducts();
                
                if (products.length === 0) {
                    document.getElementById('sGrid').innerHTML = `
                        <div class="no-products">${txt.noProducts}</div>
                    `;
                }
                
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    showShop();
                }, 1000);
            } catch (error) {
                console.error('Помилка завантаження товарів:', error);
                document.getElementById('sGrid').innerHTML = `
                    <div class="no-products">Помилка завантаження товарів. Спробуйте оновити сторінку.</div>
                `;
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function renderProducts() {
            const grid = document.getElementById('sGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            if (products.length === 0) {
                grid.innerHTML = `
                    <div class="no-products">${txt.noProducts}</div>
                `;
                return;
            }
            
            products.forEach(p => {
                const item = document.createElement('div');
                item.className = 'shop-item';
                
                const img = document.createElement('div');
                img.className = 'shop-img';
                
                if (p.photos && p.photos.length > 0) {
                    img.style.backgroundImage = `url('/api/photo/${p.photos[0]}')`;
                    img.addEventListener('click', () => {
                        const urls = p.photos.map(photoId => `/api/photo/${photoId}`);
                        openGal(urls, 0);
                    });
                } else {
                    img.style.backgroundImage = `url('f/placeholder.webp')`;
                }
                
                const content = document.createElement('div');
                content.className = 'shop-content';
                content.innerHTML = `
                    <h3 class="item-title">${p.title}</h3>
                    <p class="item-desc">${p.desc}</p>
                    <p class="item-price">₴${p.price.toFixed(2)}</p>
                    <div class="size-selector">
                        <select class="size-select">
                            ${p.sizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                        </select>
                    </div>
                    <div class="add-cart ${p.quantity <= 0 ? 'out-of-stock' : ''}">
                        ${p.quantity <= 0 ? txt.outOfStock : 'Додати до кошика'}
                    </div>
                `;
                
                const addBtn = content.querySelector('.add-cart');
                if (p.quantity > 0) {
                    addBtn.addEventListener('click', () => {
                        const size = content.querySelector('.size-select').value;
                        addCart(p, size);
                    });
                }
                
                item.appendChild(img);
                item.appendChild(content);
                grid.appendChild(item);
            });
        }
        
        function setupGallery() {
            const closeBtn = document.getElementById('closeGal');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeGal);
                closeBtn.addEventListener('mousedown', e => e.stopPropagation());
                closeBtn.addEventListener('touchstart', e => e.stopPropagation());
            }
            
            const gal = document.getElementById('galModal');
            const slider = document.getElementById('galSlider');
            
            gal.addEventListener('mousedown', swipeStart);
            gal.addEventListener('mousemove', swipeMove);
            gal.addEventListener('mouseup', swipeEnd);
            gal.addEventListener('mouseleave', swipeEnd);
            
            gal.addEventListener('touchstart', swipeStart);
            gal.addEventListener('touchmove', swipeMove);
            gal.addEventListener('touchend', swipeEnd);
            
            document.addEventListener('keydown', e => {
                if (gal.style.display === 'block') {
                    if (e.key === 'ArrowLeft') prevImg();
                    else if (e.key === 'ArrowRight') nextImg();
                    else if (e.key === 'Escape') closeGal();
                }
            });
        }
        
        function swipeStart(e) {
            if (e.target.closest('.close-gal')) return;
            
            if (e.touches && e.touches.length > 0) e = e.touches[0];
            else if (!e.clientX) return;
            
            startX = e.clientX;
            startTime = Date.now();
            swiping = true;
            sliderPos = -galIdx * 100;
            document.getElementById('galSlider').style.transition = 'none';
        }
        
        function swipeMove(e) {
            if (!swiping || animating) return;
            
            let cx = e.touches && e.touches.length > 0 ? e.touches[0].clientX : e.clientX;
            const diffX = cx - startX;
            const slider = document.getElementById('galSlider');
            slider.style.transform = `translateX(${sliderPos + (diffX / window.innerWidth * 100)}%)`;
        }
        
        function swipeEnd(e) {
            if (!swiping || animating) return;
            swiping = false;
            
            let endX = e.changedTouches && e.changedTouches.length > 0 ? 
                e.changedTouches[0].clientX : e.clientX;
            
            const diffX = endX - startX;
            const timeDiff = Date.now() - startTime;
            const vel = Math.abs(diffX) / timeDiff;
            
            if (Math.abs(diffX) > swipeThres || vel > velThres) {
                diffX > 0 ? prevImg() : nextImg();
            } else {
                updateSlider();
            }
        }

        function openGal(imgs, idx) {
            galImgs = imgs;
            galIdx = idx;
            const slider = document.getElementById('galSlider');
            slider.innerHTML = '';
            
            imgs.forEach(src => {
                const slide = document.createElement('div');
                slide.className = 'gal-img';
                const img = document.createElement('img');
                img.src = src;
                img.alt = 'Зображення товару';
                img.loading = 'eager';
                slide.appendChild(img);
                slider.appendChild(slide);
            });
            
            updateSlider();
            const gal = document.getElementById('galModal');
            gal.style.display = 'block';
            setTimeout(() => gal.style.opacity = '1', 10);
            document.getElementById('shopCont').style.display = 'none';
        }

        function closeGal() {
            const gal = document.getElementById('galModal');
            gal.style.opacity = '0';
            setTimeout(() => {
                gal.style.display = 'none';
                const shop = document.getElementById('shopCont');
                shop.style.display = 'block';
                shop.style.opacity = '0';
                setTimeout(() => shop.style.opacity = '1', 10);
            }, 200);
        }

        function updateSlider() {
            const slider = document.getElementById('galSlider');
            slider.style.transition = 'transform 0.35s ease';
            slider.style.transform = `translateX(${-galIdx * 100}%)`;
            document.getElementById('galCount').textContent = `${galIdx + 1}/${galImgs.length}`;
        }

        function nextImg() {
            if (animating) return;
            animating = true;
            galIdx = galIdx >= galImgs.length - 1 ? 0 : galIdx + 1;
            updateSlider();
            setTimeout(() => animating = false, 350);
        }

        function prevImg() {
            if (animating) return;
            animating = true;
            galIdx = galIdx <= 0 ? galImgs.length - 1 : galIdx - 1;
            updateSlider();
            setTimeout(() => animating = false, 350);
        }
        
        function addCart(p, size) {
            if (p.quantity <= 0) {
                alert(txt.outOfStock);
                return;
            }
            
            const exist = cart.find(i => i.id === p.id && i.size === size);
            
            if (exist) {
                exist.qty++;
            } else {
                cart.push({
                    ...p,
                    size,
                    qty: 1
                });
            }
            
            updateCartCount();
        }
        
        function updateCartCount() {
            const count = document.getElementById('cartCount');
            const total = cart.reduce((s, i) => s + i.qty, 0);
            count.textContent = `(${total})`;
            count.style.display = total > 0 ? 'inline' : 'none';
        }
        
        function setupEvents() {
            document.getElementById('cancelBtn').addEventListener('click', () => {
                hideForm();
                showCart();
            });
            
            document.getElementById('submitBtn').addEventListener('click', submitOrder);
            document.getElementById('succBtn').addEventListener('click', reset);
            document.getElementById('cartBtn').addEventListener('click', () => {
                hideShop();
                showCart();
            });
            document.getElementById('contShopBtn').addEventListener('click', () => {
                hideCart();
                showShop();
            });
            document.getElementById('checkoutBtn').addEventListener('click', () => {
                if (cart.length === 0) return alert('Кошик порожній');
                hideCart();
                showForm();
            });
        }
        
        function showShop() {
            const s = document.getElementById('shopCont');
            s.style.display = 'block';
            setTimeout(() => s.style.opacity = '1', 10);
        }
        
        function hideShop() {
            const s = document.getElementById('shopCont');
            s.style.opacity = '0';
            setTimeout(() => s.style.display = 'none', 200);
        }
        
        function showCart() {
            const c = document.getElementById('cartCont');
            const items = document.getElementById('cItems');
            const total = document.getElementById('totalAmt');
            
            items.innerHTML = cart.length === 0 ? 
                `<div class="empty-cart">${txt.emptyCart}</div>` : '';
            
            let sum = 0;
            cart.forEach(i => {
                const item = document.createElement('div');
                item.className = 'cart-item';
                item.innerHTML = `
                    <div class="cart-img" style="background-image:url('/api/photo/${i.photos[0]}')"></div>
                    <div class="cart-info">
                        <h3 class="cart-item-title">${i.title} (${i.size})</h3>
                        <p class="cart-price">₴${i.price.toFixed(2)} x ${i.qty}</p>
                    </div>
                    <div class="rem-item" data-id="${i.id}" data-size="${i.size}">${txt.remove}</div>
                `;
                items.appendChild(item);
                sum += i.price * i.qty;
            });
            
            total.textContent = `₴${sum.toFixed(2)}`;
            
            document.querySelectorAll('.rem-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = parseInt(e.target.getAttribute('data-id'));
                    const size = e.target.getAttribute('data-size');
                    cart = cart.filter(i => i.id !== id || i.size !== size);
                    updateCartCount();
                    showCart();
                });
            });
            
            c.style.display = 'block';
            setTimeout(() => c.style.opacity = '1', 10);
        }
        
        function hideCart() {
            const c = document.getElementById('cartCont');
            c.style.opacity = '0';
            setTimeout(() => c.style.display = 'none', 200);
        }
        
        function showForm() {
            const f = document.getElementById('formCont');
            f.style.display = 'block';
            setTimeout(() => f.style.opacity = '1', 10);
        }
        
        function hideForm() {
            const f = document.getElementById('formCont');
            f.style.opacity = '0';
            setTimeout(() => f.style.display = 'none', 200);
        }
        
        async function submitOrder() {
            const name = document.getElementById('name').value.trim();
            const contact = document.getElementById('contact').value.trim();
            
            if (!name || !contact) {
                return alert('Будь ласка, заповніть всі поля');
            }
            
            const load = document.getElementById('loading');
            load.style.display = 'flex';
            
            try {
                const response = await fetch('/api/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, contact, items: cart })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const m = document.getElementById('succMsg');
                    m.textContent = txt.succMsg(name, contact);
                    hideForm();
                    showSuccess();
                    cart = [];
                    updateCartCount();
                } else {
                    alert(result.message || 'Помилка при оформленні замовлення');
                }
            } catch (error) {
                console.error('Помилка:', error);
                alert('Помилка сервера, спробуйте пізніше');
            } finally {
                load.style.display = 'none';
            }
        }
        
        function showSuccess() {
            const s = document.getElementById('succCont');
            s.style.display = 'block';
            setTimeout(() => s.style.opacity = '1', 10);
        }
        
        function reset() {
            const s = document.getElementById('succCont');
            document.getElementById('name').value = '';
            document.getElementById('contact').value = '';
            s.style.opacity = '0';
            setTimeout(() => {
                s.style.display = 'none';
                showShop();
            }, 200);
        }
        
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
