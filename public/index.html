<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Lilivine Fashion</title>
    <link rel="icon" href="f/logo.webp" type="image/webp">
    <style>
        :root {
            --bg-dark: #0c0c15;
            --bg-medium: #151521;
            --bg-light: rgba(30, 31, 48, 0.6);
            --accent: #a0e0a0;
            --text-primary: #f0f0f0;
            --text-secondary: rgba(220, 220, 240, 0.85);
            --border: rgba(255, 255, 255, 0.08);
            --transition: all 0.25s cubic-bezier(0.22, 0.61, 0.36, 1);
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
        }
        
        @font-face {
            font-family: 'Rounded Mplus 1c';
            src: url('8.ttf') format('woff');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        
        body, button, input, textarea, select {
            font-family: 'Rounded Mplus 1c', 'Arial', sans-serif;
            letter-spacing: .3px;
        }
        
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 10% 20%, rgba(40,40,50,.05) 0%, transparent 25%),
                        radial-gradient(circle at 90% 80%, rgba(60,60,80,.05) 0%, transparent 25%),
                        linear-gradient(to bottom, #151521, #0c0c15);
            z-index: -2;
            pointer-events: none;
        }
        
        body {
            background: var(--bg-dark);
            margin: 0;
            padding: 0;
            overflow: hidden;
            perspective: 1000px;
            height: 100vh;
            touch-action: none;
            position: fixed;
            width: 100%;
            height: 100%;
            color: var(--text-primary);
            overscroll-behavior: none;
        }
        
        #world {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            will-change: transform;
            opacity: 0;
            backface-visibility: hidden;
        }
        
        .container {
            position: absolute;
            width: 90%;
            left: 50%;
            top: 50%;
            transform-style: preserve-3d;
            opacity: 0;
            transition: opacity 0.2s cubic-bezier(0.22, 0.61, 0.36, 1), transform 0.2s cubic-bezier(0.22, 0.61, 0.36, 1);
            will-change: transform, opacity;
            backface-visibility: hidden;
            backdrop-filter: blur(15px);
            z-index: 10;
            display: none;
            border-radius: 16px;
            padding: 20px;
            transform: translate3d(-50%, -50%, 0) scale(0.95);
            background: rgba(20, 21, 33, 0.92);
            border: 1px solid var(--border);
            box-shadow: 0 0 30px rgba(100, 100, 150, 0.1);
        }
        
        .btn {
            background: rgba(120, 120, 140, 0.15);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 18px;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            transform-style: preserve-3d;
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            background: rgba(140, 140, 160, 0.25);
            transform: translateZ(15px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateZ(10px) scale(.97);
            transition: transform 0.08s ease;
        }
        
        .form-cont {
            transform: translate3d(-50%, -50%, 100px);
            max-width: 350px;
        }
        
        .shop-cont {
            transform: translate3d(-50%, -50%, 80px);
            max-width: 800px;
            overflow-y: auto;
            max-height: 80vh;
        }
        
        .shop-title {
            font-size: 24px;
            text-align: center;
            margin-bottom: 25px;
            font-weight: 700;
        }
        
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .shop-item {
            background: var(--bg-light);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            transform-style: preserve-3d;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .shop-item:hover {
            transform: translateZ(15px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .shop-img {
            width: 100%;
            height: 180px;
            background-size: cover;
            background-position: center;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
            margin-bottom: 20%;
        }
        
        .shop-content {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .item-title {
            font-size: 18px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .item-desc {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.4;
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            margin-bottom: 10px;
        }
        
        .item-price {
            color: var(--accent);
            font-size: 18px;
            font-weight: 700;
            margin: 10px 0;
            flex-shrink: 0;
        }
        
        .add-cart {
            background: rgba(60, 100, 80, 0.3);
            border: 1px solid rgba(100, 180, 100, 0.3);
            margin-top: 8px;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }
        
        .add-cart:hover {
            background: rgba(80, 140, 100, 0.5);
            transform: translateZ(5px);
        }
        
        .add-cart:active {
            transform: translateZ(5px) scale(.95);
            transition: transform 0.08s ease;
        }
        
        .logo-cont {
            display: block;
            width: 150px;
            height: 150px;
            margin: 0 auto 25px;
            position: relative;
            border-radius: 50%;
            overflow: hidden;
        }
        
        .logo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: relative;
            z-index: 1;
        }
       
        .form-title {
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 15px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(40, 40, 50, 0.3);
            border: 1px solid rgba(100, 100, 120, 0.3);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 15px;
            transition: var(--transition);
        }
        
        .form-input:focus {
            border-color: rgba(180, 180, 200, 0.6);
            outline: none;
            background: rgba(50, 50, 60, 0.4);
            box-shadow: 0 0 15px rgba(150, 150, 200, 0.2);
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 15px;
        }
        
        .form-btn {
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 15px;
            flex: 1;
            font-weight: 500;
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }
        
        .form-btn.cancel {
            background: rgba(80, 20, 20, 0.3);
            border: 1px solid rgba(150, 60, 60, 0.3);
        }
        
        .form-btn.submit {
            background: rgba(30, 80, 40, 0.3);
            border: 1px solid rgba(80, 150, 80, 0.3);
        }
        
        .form-btn.submit:hover {
            background: rgba(40, 100, 50, 0.5);
            box-shadow: 0 0 20px rgba(100, 200, 100, 0.2);
        }
        
        .form-btn:hover {
            transform: translateZ(10px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .form-btn:active {
            transform: translateZ(10px) scale(.97);
            transition: transform 0.08s ease;
        }
        
        .success-cont {
            transform: translate3d(-50%, -50%, 150px);
            max-width: 350px;
            background: rgba(15, 25, 15, 0.9);
            border: 1px solid rgba(100, 200, 100, 0.2);
            text-align: center;
        }
        
        .success-icon {
            color: #70c070;
            font-size: 50px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(100, 255, 100, 0.3);
            animation: pulseSuccess 3s infinite;
        }
        
        @keyframes pulseSuccess {
            0%, 100% { transform: scale(1); opacity: .9 }
            50% { transform: scale(1.05); opacity: 1 }
        }
        
        .success-title {
            color: #e0f0e0;
            font-size: 22px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .success-msg {
            color: rgba(220, 240, 220, 0.9);
            margin-bottom: 25px;
            font-size: 16px;
            line-height: 1.5;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .loading-star {
            width: 60px;
            height: 60px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23a0a0c0"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>') center/contain no-repeat;
            animation: pulseStar 2s infinite cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        @keyframes pulseStar {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        .cart-cont {
            transform: translate3d(-50%, -50%, 100px);
            max-width: 600px;
            overflow-y: auto;
            max-height: 80vh;
        }
        
        .cart-title {
            font-size: 24px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-bottom: 15px;
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .cart-img {
            width: 70px;
            height: 70px;
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin-right: 15px;
        }
        
        .cart-info {
            flex: 1;
        }
        
        .cart-item-title {
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .cart-price {
            color: var(--accent);
            font-size: 16px;
        }
        
        .rem-item {
            color: #e74c3c;
            cursor: pointer;
            margin-left: 15px;
            transition: var(--transition);
        }
        
        .rem-item:hover {
            transform: scale(1.1);
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            margin: 20px 0;
            padding: 10px 0;
        }
        
        .total-label {
            color: #ccc;
        }
        
        .total-amount {
            color: var(--accent);
            font-weight: 700;
        }
        
        .cart-actions {
            display: flex;
            gap: 15px;
        }
        
        .cart-btn {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }
        
        .cont-shopping {
            background: rgba(80, 80, 100, 0.3);
            border: 1px solid rgba(150, 150, 180, 0.3);
        }
        
        .checkout {
            background: rgba(60, 100, 80, 0.3);
            border: 1px solid rgba(100, 180, 100, 0.3);
        }
        
        .cart-btn:hover {
            transform: translateZ(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .cart-btn:active {
            transform: translateZ(10px) scale(.97);
            transition: transform 0.08s ease;
        }
        
        .cart-btn-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .cart-icon {
            width: 20px;
            height: 20px;
            fill: #e0e0e0;
        }
        
        .gal-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 2000;
            opacity: 0;
            transition: opacity .2s ease;
        }
        
        .gal-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            z-index: 10;
            display: flex;
            justify-content: flex-start;
            pointer-events: none;
        }
        
        .close-gal {
            background: 0;
            border: 0;
            color: #fff;
            font-size: 40px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            position: relative;
            pointer-events: auto;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
            left: -10px;
        }
        
        .gal-main {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .gal-slider {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.35s cubic-bezier(0.22, 0.61, 0.36, 1);
            will-change: transform;
        }
        
        .gal-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            flex-shrink: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gal-img img {
            max-height: 85vh;
            max-width: 85vw;
            object-fit: contain;
        }
        
        .gal-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            text-align: center;
            color: #fff;
            font-size: 18px;
            z-index: 10;
        }
        
        .size-select {
            width: 100%;
            padding: 8px;
            background: rgba(40, 40, 50, 0.3);
            border: 1px solid rgba(100, 100, 120, 0.3);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .out-of-stock {
            background: rgba(100, 20, 20, 0.3) !important;
            border: 1px solid rgba(200, 60, 60, 0.3) !important;
            cursor: not-allowed;
        }
        
        .no-products {
            text-align: center;
            padding: 30px;
            color: rgba(220, 220, 220, 0.7);
            font-size: 18px;
            grid-column: 1 / -1;
        }
        
        @media (max-width: 768px) {
            .shop-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            .gal-img img {
                max-height: 80vh;
            }
        }
        
        @media (max-width: 480px) {
            .btn { padding: 14px; font-size: 16px; }
            .container {
                width: 90%;
                padding: 18px;
                max-width: 320px;
            }
            .shop-grid { grid-template-columns: 1fr; }
            .logo-cont { width: 120px; height: 120px; }
            body {
                padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            }
            .cart-item { padding: 10px; }
            .cart-img { width: 50px; height: 50px; }
            .close-gal { font-size: 35px; }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(30, 30, 40, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(100, 100, 120, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(140, 140, 160, 0.6);
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loading-star"></div>
    </div>
    
    <div id="world">
        <div class="container form-cont" id="formCont">
            <h2 class="form-title">Оформлення замовлення</h2>
            <div class="form-group">
                <label class="form-label">Повне Ім'я</label>
                <input type="text" class="form-input" id="name" required maxlength="30">
            </div>
            <div class="form-group">
                <label class="form-label">Контактна інформація</label>
                <input type="text" class="form-input" id="contact" required maxlength="50">
            </div>
            <div class="form-actions">
                <button class="form-btn cancel" id="cancelBtn">Повернутися</button>
                <button class="form-btn submit" id="submitBtn">Завершити</button>
            </div>
        </div>
        
        <div class="container shop-cont" id="shopCont">
            <div class="logo-cont">
                <img src="f/logo.webp" alt="Lilivine Fashion" class="logo">
            </div>
            
            <h2 class="shop-title"></h2>
            
            <div class="shop-grid" id="sGrid">
                <div class="no-products">Товарів немає. Будь ласка, зайдіть пізніше.</div>
            </div>
            <button class="btn" id="cartBtn" style="background:rgba(60,100,80,.3);">
                <div class="cart-btn-wrap">
                    <svg class="cart-icon" viewBox="0 0 24 24">
                        <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                    </svg>
                    <span>Кошик</span>
                    <span id="cartCount">(0)</span>
                </div>
            </button>
        </div>
        
        <div class="container cart-cont" id="cartCont">
            <h2 class="cart-title">Ваш Кошик</h2>
            <div class="cart-items" id="cItems"></div>
            <div class="cart-total">
                <span class="total-label">Разом:</span>
                <span class="total-amount" id="totalAmt">₴0.00</span>
            </div>
            <div class="cart-actions">
                <button class="cart-btn cont-shopping" id="contShopBtn">Продовжити Покупки</button>
                <button class="cart-btn checkout" id="checkoutBtn">Оформити Замовлення</button>
            </div>
        </div>
        
        <div class="container success-cont" id="succCont">
            <div class="success-icon">✓</div>
            <h2 class="success-title">Замовлення Підтверджено!</h2>
            <p class="success-msg" id="succMsg"></p>
            <button class="btn" id="succBtn">Повернутися</button>
        </div>
    </div>
    
    <div class="gal-modal" id="galModal">
        <div class="gal-header">
            <button class="close-gal" id="closeGal">✕</button>
        </div>
        <div class="gal-main" id="galMain">
            <div class="gal-slider" id="galSlider"></div>
        </div>
        <div class="gal-footer">
            <div id="galCount">1/1</div>
        </div>
    </div>

    <script>
        const txt = {
            succMsg: (n,c) => `Дякуємо ${n}, ми зв'яжемося з вами за ${c} протягом 24 годин.`,
            remove: "Видалити",
            emptyCart: "Ваш кошик порожній",
            outOfStock: "Товар закінчився",
            noProducts: "Товарів немає. Будь ласка, зайдіть пізніше."
        };
        
        let dragging = false, lastX = 0, lastY = 0, rotY = 0, rotX = 0, tY = 0, tX = 0;
        const mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let cart = [], galImgs = [], galIdx = 0, startX = 0, startTime = 0, swiping = false, sliderPos = 0;
        const swipeThres = 50, velThres = 0.3;
        let animating = false;
        let products = [];

        async function init() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('world').style.opacity = '1';
            loadProducts();
            
            setupEvents();
            animateCam();
            updateCartCount();
            setupGallery();
        }
        
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                if (!response.ok) throw new Error('Помилка завантаження');
                
                products = await response.json();
                renderProducts();
                
                if (products.length === 0) {
                    document.getElementById('sGrid').innerHTML = `
                        <div class="no-products">${txt.noProducts}</div>
                    `;
                }
                
                showShop();
            } catch (error) {
                console.error('Помилка завантаження товарів:', error);
                document.getElementById('sGrid').innerHTML = `
                    <div class="no-products">Помилка завантаження товарів. Спробуйте оновити сторінку.</div>
                `;
            }
        }
        
        function renderProducts() {
            const grid = document.getElementById('sGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            if (products.length === 0) {
                grid.innerHTML = `
                    <div class="no-products">${txt.noProducts}</div>
                `;
                return;
            }
            
            products.forEach(p => {
                const item = document.createElement('div');
                item.className = 'shop-item';
                
                const img = document.createElement('div');
                img.className = 'shop-img';
                
                if (p.photos && p.photos.length > 0) {
                    // Используем proxy для получения фото через сервер
                    img.style.backgroundImage = `url('/api/photo/${p.photos[0]}')`;
                    img.addEventListener('click', () => {
                        const urls = p.photos.map(photoId => `/api/photo/${photoId}`);
                        openGal(urls, 0);
                    });
                } else {
                    img.style.backgroundImage = `url('f/placeholder.webp')`;
                }
                
                const content = document.createElement('div');
                content.className = 'shop-content';
                content.innerHTML = `
                    <h3 class="item-title">${p.title}</h3>
                    <p class="item-desc">${p.desc}</p>
                    <p class="item-price">₴${p.price.toFixed(2)}</p>
                    <div class="size-selector">
                        <select class="size-select">
                            ${p.sizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                        </select>
                    </div>
                    <div class="add-cart ${p.quantity <= 0 ? 'out-of-stock' : ''}">
                        ${p.quantity <= 0 ? txt.outOfStock : 'Додати до кошика'}
                    </div>
                `;
                
                const addBtn = content.querySelector('.add-cart');
                if (p.quantity > 0) {
                    addBtn.addEventListener('click', () => {
                        const size = content.querySelector('.size-select').value;
                        addCart(p, size);
                    });
                }
                
                item.appendChild(img);
                item.appendChild(content);
                grid.appendChild(item);
            });
        }
        
        function setupGallery() {
            const closeBtn = document.getElementById('closeGal');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeGal);
                closeBtn.addEventListener('mousedown', e => e.stopPropagation());
                closeBtn.addEventListener('touchstart', e => e.stopPropagation());
            }
            
            const gal = document.getElementById('galModal');
            const slider = document.getElementById('galSlider');
            
            gal.addEventListener('mousedown', swipeStart);
            gal.addEventListener('mousemove', swipeMove);
            gal.addEventListener('mouseup', swipeEnd);
            gal.addEventListener('mouseleave', swipeEnd);
            
            gal.addEventListener('touchstart', swipeStart);
            gal.addEventListener('touchmove', swipeMove);
            gal.addEventListener('touchend', swipeEnd);
            
            document.addEventListener('keydown', e => {
                if (gal.style.display === 'block') {
                    if (e.key === 'ArrowLeft') prevImg();
                    else if (e.key === 'ArrowRight') nextImg();
                    else if (e.key === 'Escape') closeGal();
                }
            });
        }
        
        function swipeStart(e) {
            if (e.target.closest('.close-gal')) return;
            
            if (e.touches && e.touches.length > 0) e = e.touches[0];
            else if (!e.clientX) return;
            
            startX = e.clientX;
            startTime = Date.now();
            swiping = true;
            sliderPos = -galIdx * 100;
            document.getElementById('galSlider').style.transition = 'none';
        }
        
        function swipeMove(e) {
            if (!swiping || animating) return;
            
            let cx = e.touches && e.touches.length > 0 ? e.touches[0].clientX : e.clientX;
            const diffX = cx - startX;
            const slider = document.getElementById('galSlider');
            slider.style.transform = `translateX(${sliderPos + (diffX / window.innerWidth * 100)}%)`;
        }
        
        function swipeEnd(e) {
            if (!swiping || animating) return;
            swiping = false;
            
            let endX = e.changedTouches && e.changedTouches.length > 0 ? 
                e.changedTouches[0].clientX : e.clientX;
            
            const diffX = endX - startX;
            const timeDiff = Date.now() - startTime;
            const vel = Math.abs(diffX) / timeDiff;
            
            if (Math.abs(diffX) > swipeThres || vel > velThres) {
                diffX > 0 ? prevImg() : nextImg();
            } else {
                updateSlider();
            }
        }

        function openGal(imgs, idx) {
            galImgs = imgs;
            galIdx = idx;
            const slider = document.getElementById('galSlider');
            slider.innerHTML = '';
            
            imgs.forEach(src => {
                const slide = document.createElement('div');
                slide.className = 'gal-img';
                const img = document.createElement('img');
                img.src = src;
                img.alt = 'Зображення товару';
                img.loading = 'eager';
                slide.appendChild(img);
                slider.appendChild(slide);
            });
            
            updateSlider();
            const gal = document.getElementById('galModal');
            gal.style.display = 'block';
            setTimeout(() => gal.style.opacity = '1', 10);
            document.getElementById('shopCont').style.display = 'none';
        }

        function closeGal() {
            const gal = document.getElementById('galModal');
            gal.style.opacity = '0';
            setTimeout(() => {
                gal.style.display = 'none';
                const shop = document.getElementById('shopCont');
                shop.style.display = 'block';
                shop.style.opacity = '0';
                setTimeout(() => shop.style.opacity = '1', 10);
            }, 200);
        }

        function updateSlider() {
            const slider = document.getElementById('galSlider');
            slider.style.transition = 'transform 0.35s cubic-bezier(0.22, 0.61, 0.36, 1)';
            slider.style.transform = `translateX(${-galIdx * 100}%)`;
            document.getElementById('galCount').textContent = `${galIdx + 1}/${galImgs.length}`;
        }

        function nextImg() {
            if (animating) return;
            animating = true;
            galIdx = galIdx >= galImgs.length - 1 ? 0 : galIdx + 1;
            updateSlider();
            setTimeout(() => animating = false, 350);
        }

        function prevImg() {
            if (animating) return;
            animating = true;
            galIdx = galIdx <= 0 ? galImgs.length - 1 : galIdx - 1;
            updateSlider();
            setTimeout(() => animating = false, 350);
        }
        
        function addCart(p, size) {
            if (p.quantity <= 0) {
                alert(txt.outOfStock);
                return;
            }
            
            const exist = cart.find(i => i.id === p.id && i.size === size);
            
            if (exist) {
                exist.qty++;
            } else {
                cart.push({
                    ...p,
                    size,
                    qty: 1
                });
            }
            
            updateCartCount();
        }
        
        function updateCartCount() {
            const count = document.getElementById('cartCount');
            const total = cart.reduce((s, i) => s + i.qty, 0);
            count.textContent = `(${total})`;
            count.style.display = total > 0 ? 'inline' : 'none';
        }
        
        function setupEvents() {
            document.getElementById('cancelBtn').addEventListener('click', () => {
                hideForm();
                showCart();
            });
            
            document.getElementById('submitBtn').addEventListener('click', submitOrder);
            document.getElementById('succBtn').addEventListener('click', reset);
            document.getElementById('cartBtn').addEventListener('click', () => {
                hideShop();
                showCart();
            });
            document.getElementById('contShopBtn').addEventListener('click', () => {
                hideCart();
                showShop();
            });
            document.getElementById('checkoutBtn').addEventListener('click', () => {
                if (cart.length === 0) return alert('Кошик порожній');
                hideCart();
                showForm();
            });
            
            const els = ['formCont','succCont','shopCont','cartCont']
                .map(id => document.getElementById(id))
                .filter(Boolean);
            
            els.forEach(el => {
                el.addEventListener('mouseenter', () => dragging = false);
                el.addEventListener('mousedown', e => e.stopPropagation());
                el.addEventListener('touchstart', e => e.stopPropagation());
            });
            
            if (mobile) {
                document.addEventListener('touchstart', handleStart, {passive: false});
                document.addEventListener('touchmove', handleMove, {passive: false});
                document.addEventListener('touchend', () => dragging = false);
            } else {
                document.addEventListener('mousedown', e => { 
                    if (e.button === 0 && !e.target.closest('.container, .btn, .form-btn, .cart-btn')) { 
                        dragging = true; 
                        lastX = e.clientX; 
                        lastY = e.clientY; 
                    } 
                });
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('mouseup', () => dragging = false);
                document.addEventListener('mouseleave', () => dragging = false);
            }
        }
        
        function handleStart(e) {
            const t = e.touches[0];
            const el = document.elementFromPoint(t.clientX, t.clientY);
            if (el && !el.closest('.container, .btn, .form-btn, .cart-btn')) {
                dragging = true;
                lastX = t.clientX;
                lastY = t.clientY;
                e.preventDefault();
            }
        }
        
        function handleMove(e) {
            if (!dragging) return;
            const cx = mobile ? e.touches[0].clientX : e.clientX;
            const cy = mobile ? e.touches[0].clientY : e.clientY;
            const dx = cx - lastX, dy = cy - lastY;
            lastX = cx; lastY = cy;
            tY = Math.min(Math.max(tY + dx * 0.2, -40), 40);
            tX = Math.min(Math.max(tX + dy * 0.1, -10), 10);
            mobile && e.preventDefault();
        }
        
        function animateCam() {
            if (!dragging) {
                tY *= 0.95; 
                tX *= 0.95;
                if (Math.abs(tY) < 0.1) tY = 0;
                if (Math.abs(tX) < 0.1) tX = 0;
            }
            
            rotY += (tY - rotY) * 0.1;
            rotX += (tX - rotX) * 0.1;
            
            document.getElementById('world').style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;
            
            const ox = rotY * 0.5, oy = rotX * 0.5;
            const r = `rotateY(${-rotY * 0.2}deg) rotateX(${rotX * 0.2}deg)`;
            
            requestAnimationFrame(() => {
                const conts = {
                    'formCont': '100px',
                    'shopCont': '80px',
                    'cartCont': '100px',
                    'succCont': '150px'
                };
                
                for (const [id, z] of Object.entries(conts)) {
                    const el = document.getElementById(id);
                    if (el && el.style.display !== 'none') {
                        el.style.transform = `translate3d(calc(-50% + ${ox}px), calc(-50% + ${oy}px), ${z}) ${r}`;
                    }
                }
            });
            
            requestAnimationFrame(animateCam);
        }
        
        function showShop() {
            const s = document.getElementById('shopCont');
            s.style.display = 'block';
            s.style.opacity = '1';
        }
        
        function hideShop() {
            const s = document.getElementById('shopCont');
            s.style.opacity = '0';
            setTimeout(() => s.style.display = 'none', 200);
        }
        
        function showCart() {
            const c = document.getElementById('cartCont');
            const items = document.getElementById('cItems');
            const total = document.getElementById('totalAmt');
            
            items.innerHTML = cart.length === 0 ? 
                `<div class="empty-cart">${txt.emptyCart}</div>` : '';
            
            let sum = 0;
            cart.forEach(i => {
                const item = document.createElement('div');
                item.className = 'cart-item';
                item.innerHTML = `
                    <div class="cart-img" style="background-image:url('/api/photo/${i.photos[0]}')"></div>
                    <div class="cart-info">
                        <h3 class="cart-item-title">${i.title} (${i.size})</h3>
                        <p class="cart-price">₴${i.price.toFixed(2)} x ${i.qty}</p>
                    </div>
                    <div class="rem-item" data-id="${i.id}" data-size="${i.size}">${txt.remove}</div>
                `;
                items.appendChild(item);
                sum += i.price * i.qty;
            });
            
            total.textContent = `₴${sum.toFixed(2)}`;
            
            document.querySelectorAll('.rem-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = parseInt(e.target.getAttribute('data-id'));
                    const size = e.target.getAttribute('data-size');
                    cart = cart.filter(i => i.id !== id || i.size !== size);
                    updateCartCount();
                    showCart();
                });
            });
            
            c.style.display = 'block';
            c.style.opacity = '1';
        }
        
        function hideCart() {
            const c = document.getElementById('cartCont');
            c.style.opacity = '0';
            setTimeout(() => c.style.display = 'none', 200);
        }
        
        function showForm() {
            const f = document.getElementById('formCont');
            f.style.display = 'block';
            f.style.opacity = '1';
        }
        
        function hideForm() {
            const f = document.getElementById('formCont');
            f.style.opacity = '0';
            setTimeout(() => f.style.display = 'none', 200);
        }
        
        async function submitOrder() {
            const name = document.getElementById('name').value.trim();
            const contact = document.getElementById('contact').value.trim();
            
            if (!name || !contact) {
                return alert('Будь ласка, заповніть всі поля');
            }
            
            const load = document.getElementById('loading');
            load.style.display = 'flex';
            
            try {
                const response = await fetch('/api/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, contact, items: cart })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const m = document.getElementById('succMsg');
                    m.textContent = txt.succMsg(name, contact);
                    hideForm();
                    showSuccess();
                    cart = [];
                    updateCartCount();
                } else {
                    alert(result.message || 'Помилка при оформленні замовлення');
                }
            } catch (error) {
                console.error('Помилка:', error);
                alert('Помилка сервера, спробуйте пізніше');
            } finally {
                load.style.display = 'none';
            }
        }
        
        function showSuccess() {
            const s = document.getElementById('succCont');
            s.style.display = 'block';
            s.style.opacity = '1';
        }
        
        function reset() {
            const s = document.getElementById('succCont');
            document.getElementById('name').value = '';
            document.getElementById('contact').value = '';
            s.style.opacity = '0';
            setTimeout(() => {
                s.style.display = 'none';
                showShop();
            }, 200);
        }
        
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>